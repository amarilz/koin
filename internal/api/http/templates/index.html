<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koin</title>
    <link rel="stylesheet" href="/forms/common.css">
    <style>
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 25px;
            padding: 20px 0 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .panel-subtitle {
            font-size: 12px;
            color: #666;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            min-width: 60px;
            text-align: right;
        }

        .filter-row input[type="date"] {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 12px;
            min-width: 140px;
        }

        .filter-row select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 12px;
            background: white;
            min-width: 140px;
        }

        .filter-row button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            background: #f0f0f0;
            font-size: 12px;
            cursor: pointer;
        }

        .account-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e4e7ff;
        }

        .account-name {
            font-weight: 600;
            color: #333;
        }

        .account-balance {
            font-weight: 700;
            color: #667eea;
        }

        .transactions-table {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .transaction-row {
            display: grid;
            grid-template-columns: 110px 1fr 120px;
            gap: 12px;
            align-items: center;
            padding: 12px 16px;
            border-radius: 10px;
            background: #f9f9f9;
            border: 1px solid #eee;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
        }

        .transaction-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-title {
            font-weight: 600;
            color: #333;
        }

        .transaction-meta {
            font-size: 12px;
            color: #777;
        }

        .transaction-amount {
            text-align: right;
            font-weight: 700;
        }

        .transaction-amount.negative {
            color: #d32f2f;
        }

        .transaction-amount.positive {
            color: #2e7d32;
        }

        .empty-state {
            text-align: center;
            color: #777;
            font-size: 14px;
            padding: 24px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px dashed #ddd;
        }

        .hero {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        .hero h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .hero p {
            font-size: 16px;
            opacity: 0.95;
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .hero h2 {
                font-size: 24px;
            }

            .hero p {
                font-size: 14px;
            }

            .transaction-row {
                grid-template-columns: 1fr;
            }

            .transaction-amount {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="navbar">
            <a href="/forms" class="logo">
                ðŸ’° Koin
            </a>
            <ul class="nav-links">
                <li><a href="/forms" class="active">Home</a></li>
                <li><a href="/forms/transactions">Transazioni</a></li>
                <li><a href="/forms/accounts">Account</a></li>
                <li><a href="/forms/categories">Categorie</a></li>
                <li><a href="/logout" style="color: #d32f2f;">Logout</a></li>
            </ul>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <div class="hero">
                <h2>Benvenuto in Koin</h2>
                <p>Gestisci le tue finanze con facilitÃ </p>
            </div>

            <div class="dashboard">
                <section class="panel" style="grid-column: 1 / -1;">
                    <div class="panel-header">
                        <div>
                            <div class="panel-title">Andamento complessivo</div>
                            <div class="panel-subtitle">Visualizzazione basata sui filtri</div>
                        </div>
                    </div>
                    <div class="chart-wrapper" style="width:100%; height:260px;">
                        <canvas id="trendChart" style="width:100%; height:100%; display:block;"></canvas>
                    </div>
                </section>
                <section class="panel">
                    <div class="panel-header">
                        <div>
                            <div class="panel-title">Saldo per account</div>
                            <div class="panel-subtitle">Valori aggiornati</div>
                        </div>
                    </div>
                    <ul class="account-list" id="accountSummary">
                        <li class="empty-state">Caricamento account...</li>
                    </ul>
                </section>

                <section class="panel">
                    <div class="panel-header">
                        <div>
                            <div class="panel-title">Ultime transazioni</div>
                            <div class="panel-subtitle">Ordine cronologico inverso</div>
                        </div>
                    <div style="text-align: right; min-width: 160px;">
                        <div style="font-weight:700;">Totale filtrato</div>
                        <div id="filteredTotal" style="font-size:14px; color:#333;">â€”</div>
                    </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="dateFrom">Da</label>
                                <input type="date" id="dateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="dateTo">A</label>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="accountFilter">Account</label>
                                <select id="accountFilter">
                                    <option value="">Tutte</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="categoryFilter">Categoria</label>
                                <select id="categoryFilter">
                                    <option value="">Tutte</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-row">
                            <button type="button" id="clearFilters">Pulisci</button>
                        </div>
                    </div>
                    <div class="transactions-table" id="transactionsList">
                        <div class="empty-state">Caricamento transazioni...</div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Chart.js + date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

    <script>
        const userID = {{ .userID }} || 0;

        function formatAmount(amountInCents) {
            const amount = (amountInCents / 100).toFixed(2);
            return `${amount} â‚¬`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) {
                return dateString;
            }
            return date.toLocaleDateString('it-IT');
        }

        async function loadAccountSummary() {
            const summaryEl = document.getElementById('accountSummary');
            if (!userID) {
                summaryEl.innerHTML = '<li class="empty-state">Utente non autenticato</li>';
                return;
            }

            try {
                const response = await fetch(`/api/v1/accounts?userId=${userID}`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) {
                    summaryEl.innerHTML = '<li class="empty-state">Nessun account disponibile</li>';
                    return;
                }

                cachedAccounts = data;
                populateSelect(
                    document.getElementById('accountFilter'),
                    cachedAccounts.map((account) => account.name)
                );

                const itemsHtml = data.map((account) => `
                    <li class="account-item">
                        <span class="account-name">${account.name}</span>
                        <span class="account-balance">${formatAmount(account.currentBalance ?? account.initialBalance ?? 0)}</span>
                    </li>
                `).join('');

                const total = data.reduce((acc, account) => acc + (account.currentBalance ?? account.initialBalance ?? 0), 0);
                const totalHtml = `<li class="account-item" style="background:#eef2ff; border:1px solid #dfe8ff; font-weight:700;">` +
                    `<span class="account-name">Totale</span>` +
                    `<span class="account-balance">${formatAmount(total)}</span>` +
                    `</li>`;

                summaryEl.innerHTML = totalHtml + itemsHtml;
            } catch (error) {
                summaryEl.innerHTML = '<li class="empty-state">Errore nel caricamento account</li>';
            }
        }

        let cachedTransactions = [];
        let cachedAccounts = [];

        function populateSelect(selectEl, options) {
            const baseOption = selectEl.querySelector('option[value=""]');
            selectEl.innerHTML = '';
            if (baseOption) {
                selectEl.appendChild(baseOption);
            } else {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Tutte';
                selectEl.appendChild(emptyOption);
            }
            options.forEach((option) => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectEl.appendChild(opt);
            });
        }

        function renderTransactions(transactions) {
            const listEl = document.getElementById('transactionsList');
            if (!Array.isArray(transactions) || transactions.length === 0) {
                listEl.innerHTML = '<div class="empty-state">Nessuna transazione trovata</div>';
                return;
            }

            listEl.innerHTML = transactions.map((transaction) => {
                const amountClass = transaction.amount < 0 ? 'negative' : 'positive';
                const categoryLabel = transaction.categoryName || transaction.categoryType || 'Trasferimento';
                return `
                    <div class="transaction-row">
                        <div class="transaction-date">${formatDate(transaction.occurredAt)}</div>
                        <div class="transaction-main">
                            <div class="transaction-title">${transaction.accountName} â€¢ ${categoryLabel}</div>
                            <div class="transaction-meta">${transaction.description || ''}</div>
                        </div>
                        <div class="transaction-amount ${amountClass}">${formatAmount(transaction.amount)}</div>
                    </div>
                `;
            }).join('');
        }

        function applyDateFilter() {
            const fromValue = document.getElementById('dateFrom').value;
            const toValue = document.getElementById('dateTo').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            let fromDate = fromValue ? new Date(fromValue) : null;
            let toDate = toValue ? new Date(toValue) : null;
            if (fromDate && toDate && fromDate > toDate) {
                const tmp = fromDate;
                fromDate = toDate;
                toDate = tmp;
                document.getElementById('dateFrom').value = fromDate.toISOString().slice(0, 10);
                document.getElementById('dateTo').value = toDate.toISOString().slice(0, 10);
            }
            if (toDate) {
                toDate.setHours(23, 59, 59, 999);
            }

            const filtered = cachedTransactions.filter((transaction) => {
                if (!transaction.occurredAt) {
                    return false;
                }
                const txDate = new Date(transaction.occurredAt);
                if (fromDate && txDate < fromDate) {
                    return false;
                }
                if (toDate && txDate > toDate) {
                    return false;
                }
                if (accountFilter && transaction.accountName !== accountFilter) {
                    return false;
                }
                const categoryLabel = transaction.categoryName || transaction.categoryType || 'Trasferimento';
                if (categoryFilter && categoryLabel !== categoryFilter) {
                    return false;
                }
                return true;
            });

            // update filtered total (differenziale)
            const sum = filtered.reduce((s, tx) => s + (tx.amount || 0), 0);
            const filteredTotalEl = document.getElementById('filteredTotal');
            if (filteredTotalEl) {
                filteredTotalEl.textContent = formatAmount(sum);
                filteredTotalEl.style.color = sum < 0 ? '#d32f2f' : '#2e7d32';
            }

            renderTransactions(filtered);
            // update chart to reflect filters
            drawTrend();
        }

        function initDateFilters() {
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');

            dateFrom.addEventListener('change', () => {
                dateTo.min = dateFrom.value || '';
                if (dateTo.value && dateFrom.value && dateFrom.value > dateTo.value) {
                    dateTo.value = dateFrom.value;
                }
                applyDateFilter();
            });
            dateTo.addEventListener('change', () => {
                dateFrom.max = dateTo.value || '';
                if (dateTo.value && dateFrom.value && dateFrom.value > dateTo.value) {
                    dateFrom.value = dateTo.value;
                }
                applyDateFilter();
            });
            document.getElementById('accountFilter').addEventListener('change', applyDateFilter);
            document.getElementById('categoryFilter').addEventListener('change', applyDateFilter);
            document.getElementById('clearFilters').addEventListener('click', () => {
                setDefaultLast30Days();
                document.getElementById('accountFilter').value = '';
                document.getElementById('categoryFilter').value = '';
                applyDateFilter();
            });
        }

        function setDefaultLast30Days() {
            const today = new Date();
            const fromDate = new Date();
            fromDate.setDate(today.getDate() - 30);
            const dateFromValue = fromDate.toISOString().slice(0, 10);
            const dateToValue = today.toISOString().slice(0, 10);
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            dateFrom.value = dateFromValue;
            dateTo.value = dateToValue;
            dateFrom.max = dateToValue;
            dateTo.min = dateFromValue;
        }

        async function loadRecentTransactions() {
            const listEl = document.getElementById('transactionsList');
            if (!userID) {
                listEl.innerHTML = '<div class="empty-state">Utente non autenticato</div>';
                return;
            }

            try {
                const response = await fetch(`/api/v1/transactions?userId=${userID}&limit=1000`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">Nessuna transazione trovata</div>';
                    return;
                }

                cachedTransactions = data;
                const categories = Array.from(new Set(
                    cachedTransactions.map((tx) => tx.categoryName || tx.categoryType || 'Trasferimento')
                ));
                populateSelect(document.getElementById('categoryFilter'), categories);
                applyDateFilter();
                drawTrend();
            } catch (error) {
                listEl.innerHTML = '<div class="empty-state">Errore nel caricamento transazioni</div>';
            }
        }

        let _trendChart = null;

        function drawTrend() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;

            // determine date range from filters
            const fromValue = document.getElementById('dateFrom').value;
            const toValue = document.getElementById('dateTo').value;
            let fromDate = fromValue ? new Date(fromValue) : null;
            let toDate = toValue ? new Date(toValue) : null;
            if (!fromDate || !toDate) {
                const today = new Date();
                toDate = toDate || new Date();
                fromDate = fromDate || new Date();
                fromDate.setDate(today.getDate() - 30);
            }
            fromDate = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
            toDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());

            // build list of days
            const days = [];
            for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                days.push(new Date(d));
            }

            // baseline totalNow
            const accountFilter = document.getElementById('accountFilter').value;
            let totalNow = 0;
            if (accountFilter) {
                const acc = cachedAccounts.find(a => a.name === accountFilter);
                totalNow = (acc && (acc.currentBalance ?? acc.initialBalance)) || 0;
            } else {
                totalNow = cachedAccounts.reduce((s, a) => s + (a.currentBalance ?? a.initialBalance ?? 0), 0);
            }

            const accountFilterVal = document.getElementById('accountFilter').value;
            const categoryFilterVal = document.getElementById('categoryFilter').value;

            // compute totals per day (in euros)
            const dataPoints = days.map((day) => {
                const dayEnd = new Date(day.getFullYear(), day.getMonth(), day.getDate(), 23, 59, 59, 999);
                const sumAfterDay = cachedTransactions.reduce((s, tx) => {
                    if (!tx.occurredAt) return s;
                    const txDate = new Date(tx.occurredAt);
                    if (txDate > dayEnd) {
                        if (accountFilterVal && tx.accountName !== accountFilterVal) return s;
                        const categoryLabel = tx.categoryName || tx.categoryType || 'Trasferimento';
                        if (categoryFilterVal && categoryLabel !== categoryFilterVal) return s;
                        return s + tx.amount;
                    }
                    return s;
                }, 0);
                const valueCents = totalNow - sumAfterDay;
                return { x: new Date(day), y: valueCents / 100 };
            });

            const labels = dataPoints.map(p => p.x);
            const data = dataPoints.map(p => p.y);

            const ctx = canvas.getContext('2d');

            if (!_trendChart) {
                // Create chart with fixed wrapper height; use maintainAspectRatio:true to avoid resize loops
                _trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Saldo (â‚¬)',
                            data: dataPoints,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102,126,234,0.12)',
                            tension: 0.25,
                            pointRadius: 3,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'nearest', intersect: false },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) {
                                        const v = ctx.parsed.y;
                                        return formatAmount(Math.round(v * 100));
                                    }
                                }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy' },
                                ticks: { maxRotation: 0, autoSkip: true }
                            },
                            y: {
                                ticks: {
                                    callback: function(value) { return value + ' â‚¬'; }
                                }
                            }
                        }
                    }
                });
            } else {
                _trendChart.data.datasets[0].data = dataPoints;
                _trendChart.update();
                // ensure chart uses full width of wrapper
                try { _trendChart.resize(); } catch (e) { /* ignore */ }
            }
        }

        loadAccountSummary();
        setDefaultLast30Days();
        loadRecentTransactions();
        initDateFilters();
    </script>
</body>
</html>
